<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flap Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg"/>
</head>
<body class="background">
    <div class="header">
        <div class="header-img-wrapper">
            <div id="leaf" class="header-img-bg"></div>
            <object id="svg1" data="logo.svg" type="image/svg+xml"></object>
        </div>
    </div>
    <div class="content">
        <div class="card">
            <input id="char_input" maxlength="1" class="hidden-input"/>
            <div class="card-top">
                <div>Display</div>
            </div>
            <div class="card-body">
                <div id="display"></div>
                <hr class="card-line">
                <div class="container-row">
                    <input type="button" value="Clear Preview" class="btn btn-submit max-width-150" onclick="clear_all_flaps()">
                    <input type="button" name="cmd-get-dimensions" value="Read Flaps" class="btn btn-submit max-width-150" onclick="get_dimensions()"/>
                    <input type="button" name="cmd-set-message" value="Set Flaps" class="btn btn-submit max-width-150" onclick="set_message()"/>
                </div>
            </div>  
        </div>

        <div class="card">
            <div class="card-top">
                <div>Flap Controller Firmware</div>
            </div>
            <div class="card-body">
                <form action="/" enctype="multipart/form-data" method="post">
                    <div class="container-row">
                        <input class="fileUpload-path" id="controller-firmware-update-path" placeholder="Choose File" disabled="disabled" />
                        <div class="btn fileUpload-btn" id="controller-firmware-update-btn">
                            <svg class="fileUpload-icon" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px"><g><rect fill="none" height="24" width="24"/></g><g><path d="M20,6h-8l-2-2H4C2.9,4,2.01,4.9,2.01,6L2,18c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z M20,18L4,18V6h5.17 l2,2H20V18z M9.41,14.42L11,12.84V17h2v-4.16l1.59,1.59L16,13.01L12.01,9L8,13.01L9.41,14.42z"/></g></svg>
                            <input name="cmd-controller-firmware" id="controller-firmware-update-btn-hidden" type="file" accept=".bin" class="upload"/>
                        </div>
                    </div>
                    <div class="container-row-reverse">
                        <input type="submit" value="Submit" class="btn btn-submit max-width-150">
                    </div>
                </form>
            </div>  
        </div>
        <div class="card">
            <div class="card-top">
                <div>Flap Module Firmware</div>
            </div>
            <div class="card-body">
                <form action="/" enctype="multipart/form-data" method="post">
                    <div class="container-row">
                        <input class="fileUpload-path" id="module-firmware-update-path" placeholder="Choose File" disabled="disabled" />
                        <div class="btn fileUpload-btn" id="module-firmware-update-btn">
                            <svg class="fileUpload-icon" xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24px" viewBox="0 0 24 24" width="24px"><g><rect fill="none" height="24" width="24"/></g><g><path d="M20,6h-8l-2-2H4C2.9,4,2.01,4.9,2.01,6L2,18c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V8C22,6.9,21.1,6,20,6z M20,18L4,18V6h5.17 l2,2H20V18z M9.41,14.42L11,12.84V17h2v-4.16l1.59,1.59L16,13.01L12.01,9L8,13.01L9.41,14.42z"/></g></svg>
                            <input name="cmd-module-firmware" id="module-firmware-update-btn-hidden" type="file" accept=".hex" class="upload"/>
                        </div>
                    </div>
                    <div class="container-row-reverse">
                        <input type="submit" value="Submit" class="btn btn-submit max-width-150">
                    </div>
                </form>
            </div>  
        </div>
        <div class="card">
            <div class="card-top">
                <div>Debug</div>
            </div>
            <div class="card-body">
                <div class="container-row">
                    <input class="debug-input" id="raw-command" placeholder="0x81 0x83 ..." />
                    <input type="button" name="cmd-get-dimensions" value="Send Command" class="btn btn-submit max-width-150" onclick="debug_raw_cmd()"/>
                    <input type="button" name="cmd-set-message" value="Clear Log" class="btn btn-submit max-width-150" onclick="debug_clear_log()"/>
                </div>
                <pre id="log" class="debug background"></pre>
            </div>  
        </div>
    </div>
    <div class="spacer"></div>
    <div class="footer">
    </div>
    <script>
        let flaps = [];
        let flap_selected;
        let repeat_key = 0;
        let dimensions = {cols:0,rows:0};
        const char_input = document.getElementById("char_input");
        let flap_id_max;
        let flap_set = [' ', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'â‚¬', '$', '!', '.', '?', ',', ':', '/', '&', '@', '#']
 
        function flap_next(flap){
            if(flap.className == "flap-div"){
                let index = parseInt(flap.dataset.index);
                index++;
                if(index == flaps.length) index = 0;
                return flaps.at(index);
            }
            return flaps.at(0);
        }

        function flap_prev(flap){
            if(flap != undefined && flap.className == "flap-div"){
                let index = parseInt(flap.dataset.index);
                index--;
                if(index == flaps.length) index = -1;
                return flaps.at(index);
            }
            return flaps.at(0);
        }

        function flap_above(flap){
            if(flap != undefined && flap.className == "flap-div"){
                let index = parseInt(flap.dataset.index);
                index-= dimensions.cols;
                if(index < 0) index += flaps.length;
                return flaps.at(index);
            }
            return flaps.at(0);
        }

        function flap_below(flap){
            if(flap != undefined && flap.className == "flap-div"){
                let index = parseInt(flap.dataset.index);
                index+= dimensions.cols;
                if(index > flaps.length-1) index -= flaps.length;
                return flaps.at(index);
            }
            return flaps.at(0);
        }

        function set_letter(flap,letter){
            if(flap != undefined && flap.className == "flap-div"){
                let flap_char = flap.firstElementChild.firstElementChild.nextElementSibling.firstElementChild
                letter = letter.toUpperCase();
                if(!flap_set.includes(letter))letter = ' ';
                flap.setAttribute("data-prev_char",letter);
                flap_char.innerHTML = letter;
            }
        }

        function select_flap(flap){
            if(flap != undefined && flap.className == "flap-div"){
                flap_selected = flap;
                let flap_char = flap.firstElementChild.firstElementChild.nextElementSibling.firstElementChild;
                flap.setAttribute("data-prev_char",flap_char.innerHTML);
                flap_char.setAttribute("class","flap-letter flap-selected");
                flap_char.innerHTML = '_';

                char_input.oninput = function(){
                    set_letter(flap_selected,this.value);
                    if(flaps.length > 1){
                        let next = flap_next(flap_selected);
                        next.onclick();
                    }else{
                        char_input.blur();
                    }
                }
                char_input.onblur = function(){
                    unselect_flap(flap_selected);
                }
                char_input.focus();
            }
        }

        function get_string_from_flaps(){
            let str = '';
            for (let i = 0; i < flaps.length; i++) {
                str += flaps.at(i).firstElementChild.firstElementChild.nextElementSibling.firstElementChild.innerHTML;
            }
            return str;
        }

        function clear_all_flaps(){
            for (flap of flaps) {
                set_letter(flap,' ');
            }
        }

        function unselect_flap(flap){
            if(flap != undefined && flap.className == "flap-div"){
                flap_selected = undefined;
                let flap_char = flap.firstElementChild.firstElementChild.nextElementSibling.firstElementChild;
                flap_char.innerHTML = flap.dataset.prev_char;
                flap_char.setAttribute("class","flap-letter");

                char_input.oninput = function(){};
                char_input.onblur = function(){};
                char_input.value = '';
            }
        }
        
        function flap_click()
        {
            unselect_flap(flap_selected);
            select_flap(this);
        }

        function set_message(){
            console.log(get_string_from_flaps());
            socket.send(JSON.stringify({command:"cmd-set-message",data:get_string_from_flaps()}))
        }

        function get_message(){
            socket.send(JSON.stringify({command:"cmd-get-message",data:""}))
        }

        function get_dimensions(){
            socket.send(JSON.stringify({command:"cmd-get-dimensions",data:""}))
        }

        function set_dimensions(cols,rows){
            flaps = [];
            dimensions.rows = rows; dimensions.cols = cols;
            console.log("creating display of " + cols + " x " + rows);
            const display = document.getElementById("display");
            //calculate width of of flap elements based on a wanted card height of 250px
            const wanted_height = 250.0 + rows - 1;
            let flap_ratio = 21.0/16.0;
            let display_width = cols * 100 * wanted_height/((display.parentElement.clientWidth-30)*flap_ratio*rows)
            if(display_width > 100) display_width = 100;
            display.setAttribute("style","width:"+display_width+"%;");
            let width = 100/cols;
            // if(width > 25) width = 25;
            display.innerHTML = '';
            for (let i = 0; i < cols*rows; i++) {
                let flap_div = document.createElement("div");
                let flap = document.createElementNS("http://www.w3.org/2000/svg","svg");
                let flap_rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
                let flap_text = document.createElementNS("http://www.w3.org/2000/svg","text");
                let flap_tspan = document.createElementNS("http://www.w3.org/2000/svg","tspan");
                let flap_path = document.createElementNS("http://www.w3.org/2000/svg","path");
                display.appendChild(flap_div);
                flap_div.appendChild(flap);
                flap.appendChild(flap_rect);
                flap.appendChild(flap_text);
                flap_text.appendChild(flap_tspan);
                flap.appendChild(flap_path);          
                flap_div.setAttribute("style","width:"+width+"%;");
                flap_div.setAttribute("id","flap-"+i);
                flap_div.setAttribute("data-index",i);
                flap_id_max = "flap-"+i;
                flap_div.setAttribute("class","flap-div");
                flap_div.onclick = flap_click;
                flap.setAttribute("viewBox","0 0 16 21");
                flap.setAttribute("class","flap");
                flap_rect.setAttribute("class","flap-rect");
                flap_rect.setAttribute("width","16");
                flap_rect.setAttribute("height","21");
                flap_rect.setAttribute("ry","1.5");
                flap_tspan.innerHTML = ' ';
                flap_tspan.setAttribute("class","flap-letter");
                flap_tspan.setAttribute("x","8");
                flap_tspan.setAttribute("y","18");
                flap_path.setAttribute("class","flap-split");
                flap_path.setAttribute("d","M 0,10.5 H 16");
                flaps.push(flap_div);
            }
            socket.send(JSON.stringify({command:"cmd-set-dimensions",data:{height:dimensions["rows"],width:dimensions["cols"]}}))
            get_message();
        }

        function debug_log(message){
            document.getElementById("log").innerHTML+='<span class="debug-msg">'+message+'</span>\n'
        }

        function debug_clear_log(message){
            document.getElementById("log").innerHTML=''
        }

        function debug_raw_cmd(){
            var raw_cmd = document.getElementById('raw-command').value;
            var cmd_regex = /^(0x[0-9a-fA-F]{2} ?)+$/;
            if(!cmd_regex.test(raw_cmd)){
                alert("command is not well formated");
                return;
            }
           socket.send(JSON.stringify({command:"cmd-raw-cmd",data:document.getElementById("raw-command").value}))
        }

        function parse_ws_message(message){
            const msg = JSON.parse(message.data);
            console.log(msg)
            switch (msg["command"]) {
                case "set-dimensions":
                    set_dimensions(msg["data"]["width"],msg["data"]["height"]);
                    break;
                case "set-char":
                    if(dimensions["rows"]*dimensions["cols"] == msg["data"].length){
                        for (flap of flaps) {
                            set_letter(flap,msg["data"].charAt(parseInt(flap.dataset.index)));
                        }
                    }
                    break;
                case "debug-log":
                        debug_log(msg["data"]);
                    break;
                default:
                    break;
            }
        }

        window.addEventListener("keydown", function (event) {
            if (event.defaultPrevented) {
                return; // Do nothing if the event was already processed
            }
            do{
                if(flap_selected != undefined){
                    switch (event.key) {
                        case "Tab":
                            event.preventDefault();
                        break;
                        case "Enter":
                            window.dispatchEvent(new KeyboardEvent('keydown',  {'key':'ArrowLeft','ctrlKey':true}));
                        case "PageDown":
                        case "ArrowDown":
                            flap_below(flap_selected).onclick();
                        break;
                        case "PageUp":
                        case "ArrowUp":
                            flap_above(flap_selected).onclick();
                        break;
                        case "Home":
                            flaps.at(0).onclick()
                        break;
                        case "Backspace":
                            set_letter(flap_selected,' ');
                        case "ArrowLeft":
                            if(!repeat_key && event.ctrlKey){
                                repeat_key = parseInt(flap_selected.dataset.index)%dimensions.cols + 1;
                            }else{
                                flap_prev(flap_selected).onclick();
                                if(event.key == "Backspace") set_letter(flap_selected,' ');
                            }
                        break;
                        case "End":
                            flaps.at(-1).onclick()
                        break;
                        case "Delete":
                            set_letter(flap_selected,' ');
                        case "ArrowRight":
                            if(!repeat_key && event.ctrlKey){
                                repeat_key = dimensions.cols-(parseInt(flap_selected.dataset.index)%(dimensions.cols));
                            }else{
                                flap_next(flap_selected).onclick();
                                if(event.key == "Delete") set_letter(flap_selected,' ');
                            }
                        break;
                        default:
                        return;
                    }
                }
                if(repeat_key)repeat_key--;
            }while(repeat_key);
            }, true);
        
        document.getElementById("controller-firmware-update-btn").onclick = function () {
            document.getElementById("controller-firmware-update-btn-hidden").click();
        };
        document.getElementById("controller-firmware-update-btn-hidden").onchange = function () {
            document.getElementById("controller-firmware-update-path").value = this.value;
        };
        document.getElementById("module-firmware-update-btn").onclick = function () {
            document.getElementById("module-firmware-update-btn-hidden").click();
        };
        document.getElementById("module-firmware-update-btn-hidden").onchange = function () {
            document.getElementById("module-firmware-update-path").value = this.value;
        };

        let socket = null;
        window.onload = function (){
            socket = new WebSocket( "ws://" + document.domain + "/ws" );
            socket.onopen = function(){ 
                console.log("socket open"); 
                get_dimensions();
            }
            socket.onclose = function() { console.log("socket close"); }
            socket.onmessage = parse_ws_message;
        }
   </script>
</body>
</html>
